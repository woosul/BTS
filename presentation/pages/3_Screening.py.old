"""
BTS ì¢…ëª©ì„ ì • í˜ì´ì§€

KRW/BTC ì‹œì¥ì—ì„œ íˆ¬ì ê°€ì¹˜ê°€ ë†’ì€ ì¢…ëª©ì„ ì„ ì •
"""
import streamlit as st
import sys
from pathlib import Path
import pandas as pd
from datetime import datetime

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì¶”ê°€
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from application.services.screening_service import ScreeningService
from infrastructure.exchanges.upbit_client import UpbitClient
from utils.logger import get_logger
from presentation.components.strategy_card import render_strategy_card
from presentation.components.strategy_modal import show_strategy_config_modal

logger = get_logger(__name__)

st.set_page_config(
    page_title="ì¢…ëª©ì„ ì • - BTS",
    page_icon="",
    layout="wide"
)

# ì‚¬ì´ë“œë°” ë¡œê³  ì„¤ì •
# ì‚¬ì´ë“œë°” ë¡œê³  ì„¤ì •
logo_path = str(project_root / "resource" / "image" / "peaknine_logo_01.svg")
icon_path = str(project_root / "resource" / "image" / "peaknine_02.png")
st.logo(
    image=logo_path,
    icon_image=logo_path
)

# ë¡œê³  í¬ê¸° ì¡°ì • ë° ë©”ë‰´ ìŠ¤íƒ€ì¼
st.markdown("""
<style>
    /* Noto Sans KR í°íŠ¸ ë¡œë“œ */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
    /* Bootstrap Icons ë¡œë“œ */
    @import url('https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css');
    /* Material Icons ë¡œë“œ */
    @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200');

    /* ì „ì²´ í°íŠ¸ ì ìš© (ì•„ì´ì½˜ ì œì™¸) */
    html, body, [class*="css"] {
        font-family: 'Noto Sans KR', sans-serif !important;
    }

    /* Streamlit ë‚´ë¶€ ìš”ì†Œ í°íŠ¸ ì ìš© */
    p, h1, h2, h3, h4, h5, h6, label, input, textarea, select, button,
    [data-testid] div, [data-testid] span, [data-testid] p,
    .stMarkdown, .stText, .stCaption {
        font-family: 'Noto Sans KR', sans-serif !important;
    }

    /* Material Icons ìš”ì†ŒëŠ” ì›ë˜ í°íŠ¸ ìœ ì§€ */
    .material-symbols-outlined,
    [class*="material-icons"],
    span[data-testid*="stIcon"],
    button span,
    [role="button"] span {
        font-family: 'Material Symbols Outlined', 'Material Icons' !important;
    }

    [data-testid="stSidebarNav"] {
        padding-top: 0 !important;
    }
    [data-testid="stSidebarNav"] > div:first-child {
        padding: 1.5rem 1rem !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;
    }
    [data-testid="stSidebarNav"] a {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;
    }
    [data-testid="stSidebarNav"] img {
        width: 90% !important;
        max-width: 280px !important;
        height: auto !important;
    }
    [data-testid="stSidebarNav"] ul {
        margin-top: 1rem !important;
    }
    [data-testid="stSidebarNav"] ul li a {
        text-align: left !important;
        justify-content: flex-start !important;
    }
</style>
""", unsafe_allow_html=True)

def get_services():
    """ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°"""
    if 'db' not in st.session_state:
        from infrastructure.database.connection import SessionLocal
        st.session_state.db = SessionLocal()

    if 'screening_service' not in st.session_state:
        exchange = UpbitClient()
        st.session_state.screening_service = ScreeningService(st.session_state.db, exchange)

    return st.session_state.screening_service

def main():
    # ì „ì²´ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ì¡°ì •
    st.markdown("""
    <style>
    /* íƒ€ì´í‹€ í¬ê¸° ì¡°ì • */
    h1 {
        font-size: 1.8rem !important;
        margin-top: 0.5rem !important;
        margin-bottom: 0.5rem !important;
    }
    h2 {
        font-size: 1.3rem !important;
        margin-top: 0.8rem !important;
        margin-bottom: 0.5rem !important;
    }
    h3 {
        font-size: 1.1rem !important;
        margin-top: 0.6rem !important;
        margin-bottom: 0.4rem !important;
    }
    /* êµ¬ë¶„ì„  ì—¬ë°± ì¡°ì • */
    hr {
        margin-top: 0.8rem !important;
        margin-bottom: 0.8rem !important;
    }
    /* ë¸”ë¡ ìš”ì†Œ ì—¬ë°± ì¡°ì • */
    .block-container {
        padding-top: 2rem !important;
        padding-bottom: 1rem !important;
    }
    </style>
    """, unsafe_allow_html=True)

    st.markdown("<h1>ì¢…ëª©ì„ ì •</h1>", unsafe_allow_html=True)
    st.markdown("<hr style='margin: 0.5rem 0;'>", unsafe_allow_html=True)

    # ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
    screening_service = get_services()

    # ì‚¬ì´ë“œë°”: ìŠ¤í¬ë¦¬ë‹ ì„¤ì •
    with st.sidebar:
        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ìŠ¤í¬ë¦¬ë‹ ì„¤ì •</h3>", unsafe_allow_html=True)

        # ì‹œì¥ ì„ íƒ
        market = st.selectbox(
            "ì‹œì¥",
            options=["KRW", "BTC"],
            help="ëŒ€ìƒ ì‹œì¥ ì„ íƒ"
        )

        # ì „ëµ ì„ íƒ
        strategy_type = st.selectbox(
            "ì „ëµ",
            options=["momentum", "volume", "technical", "hybrid"],
            format_func=lambda x: {
                "momentum": "ëª¨ë©˜í…€ ê¸°ë°˜",
                "volume": "ê±°ë˜ëŸ‰ ê¸°ë°˜",
                "technical": "ê¸°ìˆ ì§€í‘œ ë³µí•©",
                "hybrid": "í•˜ì´ë¸Œë¦¬ë“œ"
            }[x],
            help="ìŠ¤í¬ë¦¬ë‹ ì „ëµ ì„ íƒ"
        )

        # ì‹œì¥ì˜ ì „ì²´ ì¢…ëª© ìˆ˜ ë¯¸ë¦¬ ì¡°íšŒ (ëŒ€ëµì ì¸ ìˆ˜)
        try:
            from infrastructure.exchanges.upbit_client import UpbitClient
            temp_exchange = UpbitClient()
            market_symbols = temp_exchange.get_market_symbols(market)
            total_symbols = len(market_symbols)
            # 5ì˜ ë°°ìˆ˜ë¡œ ì˜¬ë¦¼
            max_symbols = ((total_symbols + 4) // 5) * 5
        except:
            total_symbols = 200
            max_symbols = 200

        # ìƒìœ„ ì¢…ëª© ìˆ˜
        # í•œ ì¤„ì— ë°°ì¹˜í•˜ê¸° ìœ„í•´ columns ì‚¬ìš©
        cols = st.columns([0.65, 0.35])

        with cols[0]:
            st.markdown("<h3 style='margin-bottom: 0.5rem;'>ì„ ì • ì¢…ëª© ìˆ˜</h3>", unsafe_allow_html=True)

        with cols[1]:
            # ìˆ˜ì§ ì •ë ¬ ë° ìš°ì¸¡ ì •ë ¬ì„ ìœ„í•´ HTML ì‚¬ìš©
            st.markdown(
                """
                <div style="display: flex; justify-content: flex-end; align-items: center; height: 40px;">
                </div>
                """,
                unsafe_allow_html=True
            )
            # ìš°ì¸¡ ì •ë ¬ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ
            col_right = st.container()
            with col_right:
                show_all = st.toggle("All", value=False, help="ì „ì²´ ì¢…ëª© í‘œì‹œ", key="show_all_toggle")

        if show_all:
            st.info(f"ì „ì²´ ì¢…ëª©ì„ í‘œì‹œí•©ë‹ˆë‹¤ (ì´ {total_symbols}ê°œ)")
            top_n = total_symbols
        else:
            top_n = st.slider(
                "ìƒìœ„ ì¢…ëª©",
                min_value=5,
                max_value=max_symbols,
                value=10,
                step=5,
                help=f"ìƒìœ„ Nê°œ ì¢…ëª© ì„ ì • (ìµœëŒ€ {max_symbols}ê°œ)",
                label_visibility="collapsed"
            )
            st.caption(f"ìƒìœ„ {top_n}ê°œ ì¢…ëª© (ì „ì²´ {total_symbols}ê°œ ì¤‘)")

        st.markdown("<hr style='margin: 0.8rem 0;'>", unsafe_allow_html=True)

        # ì „ëµ ì„¤ì • (ì¹´ë“œ + ëª¨ë‹¬ ë°©ì‹)
        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ì „ëµ ì„¤ì •</h3>", unsafe_allow_html=True)

        # Session state ì´ˆê¸°í™”
        if f"strategy_params_{strategy_type}" not in st.session_state:
            st.session_state[f"strategy_params_{strategy_type}"] = None

        # í˜„ì¬ ì„¤ì •ëœ íŒŒë¼ë¯¸í„°
        strategy_params = st.session_state.get(f"strategy_params_{strategy_type}")

        # ì „ëµ ì´ë¦„ ë§¤í•‘
        strategy_names = {
            "momentum": "ëª¨ë©˜í…€ ê¸°ë°˜",
            "volume": "ê±°ë˜ëŸ‰ ê¸°ë°˜",
            "technical": "ê¸°ìˆ ì§€í‘œ ë³µí•©",
            "hybrid": "í•˜ì´ë¸Œë¦¬ë“œ"
        }

        strategy_name = strategy_names.get(strategy_type, strategy_type)

        # ì „ëµ ì¹´ë“œ ë Œë”ë§
        button_clicked = render_strategy_card(
            strategy_name=strategy_name,
            strategy_type=strategy_type,
            strategy_params=strategy_params,
            card_key=strategy_type
        )

        # ì„¤ì • ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        if button_clicked:
            show_strategy_config_modal(
                strategy_name=strategy_name,
                strategy_type=strategy_type,
                current_params=strategy_params
            )

        # ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ íŒŒë¼ë¯¸í„° ì‚¬ìš©
        if not strategy_params:
            if strategy_type == "momentum":
            st.write("**ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")
            price_weight = st.slider(
                "ê°€ê²© ìƒìŠ¹ë¥ ",
                0.0, 1.0, 0.4, 0.1,
                help="ê°€ê²© ë³€ë™ë¥  ê°€ì¤‘ì¹˜"
            )
            volume_weight = st.slider(
                "ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨",
                0.0, 1.0, 0.3, 0.1,
                help="ê±°ë˜ëŸ‰ ë³€ë™ë¥  ê°€ì¤‘ì¹˜"
            )
            rsi_weight = st.slider(
                "RSI ëª¨ë©˜í…€",
                0.0, 1.0, 0.3, 0.1,
                help="RSI ëª¨ë©˜í…€ ê°€ì¤‘ì¹˜"
            )

            # ê°€ì¤‘ì¹˜ í•©ê³„ ì²´í¬
            total = price_weight + volume_weight + rsi_weight
            if abs(total - 1.0) > 0.01:
                st.warning(f"ê°€ì¤‘ì¹˜ í•©ê³„: {total:.2f} (1.0ì´ì–´ì•¼ í•¨)")

            st.markdown("---")
            st.write("**ê¸°ê°„ ì„¤ì •**")
            st.caption("ì„ íƒí•œ ê¸°ê°„ì˜ ëª¨ë©˜í…€ì„ ì¡°í•©í•˜ì—¬ í‰ê°€í•©ë‹ˆë‹¤.")

            col1, col2, col3 = st.columns(3)
            with col1:
                period_1d = st.checkbox("1ì¼ ëª¨ë©˜í…€", value=True, help="ìµœê·¼ 24ì‹œê°„")
            with col2:
                period_7d = st.checkbox("7ì¼ ëª¨ë©˜í…€", value=True, help="ìµœê·¼ 7ì¼")
            with col3:
                period_30d = st.checkbox("30ì¼ ëª¨ë©˜í…€", value=True, help="ìµœê·¼ 30ì¼")

            if not any([period_1d, period_7d, period_30d]):
                st.warning("âš ï¸ ìµœì†Œ 1ê°œ ê¸°ê°„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.")

            strategy_params = {
                "price_weight": price_weight,
                "volume_weight": volume_weight,
                "rsi_weight": rsi_weight,
                "period_1d": period_1d,
                "period_7d": period_7d,
                "period_30d": period_30d,
            }

        elif strategy_type == "volume":
            st.write("**ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")
            amount_weight = st.slider(
                "ê±°ë˜ëŒ€ê¸ˆ",
                0.0, 1.0, 0.5, 0.1,
                help="ê±°ë˜ëŒ€ê¸ˆ(ê±°ë˜ëŸ‰ * ê°€ê²©) ê°€ì¤‘ì¹˜"
            )
            surge_weight = st.slider(
                "ê±°ë˜ëŸ‰ ê¸‰ì¦",
                0.0, 1.0, 0.5, 0.1,
                help="í‰ê·  ëŒ€ë¹„ ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨ ê°€ì¤‘ì¹˜"
            )

            # ê°€ì¤‘ì¹˜ í•©ê³„ ì²´í¬
            total = amount_weight + surge_weight
            if abs(total - 1.0) > 0.01:
                st.warning(f"ê°€ì¤‘ì¹˜ í•©ê³„: {total:.2f} (1.0ì´ì–´ì•¼ í•¨)")

            st.markdown("---")
            st.write("**ì„ê³„ê°’ ì„¤ì •**")

            threshold = st.slider(
                "ê±°ë˜ëŸ‰ ë°°ìˆ˜",
                1.0, 5.0, 1.5, 0.1,
                help="í‰ê·  ëŒ€ë¹„ Në°° ì´ìƒì´ë©´ ë†’ì€ ì ìˆ˜"
            )

            period = st.number_input(
                "í‰ê·  ê³„ì‚° ê¸°ê°„ (ì¼)",
                min_value=5,
                max_value=100,
                value=20,
                step=5,
                help="ìµœê·¼ Nì¼ í‰ê·  ê±°ë˜ëŸ‰ ê¸°ì¤€"
            )

            strategy_params = {
                "amount_weight": amount_weight,
                "surge_weight": surge_weight,
                "threshold": threshold,
                "period": period,
            }

        elif strategy_type == "technical":
            st.write("**ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")
            rsi_weight = st.slider(
                "RSI",
                0.0, 1.0, 0.3, 0.1,
                help="RSI ì§€í‘œ ê°€ì¤‘ì¹˜"
            )
            macd_weight = st.slider(
                "MACD",
                0.0, 1.0, 0.4, 0.1,
                help="MACD ì§€í‘œ ê°€ì¤‘ì¹˜"
            )
            ma_weight = st.slider(
                "ì´ë™í‰ê· ",
                0.0, 1.0, 0.3, 0.1,
                help="ì´ë™í‰ê·  ì •ë°°ì—´ ê°€ì¤‘ì¹˜"
            )

            # ê°€ì¤‘ì¹˜ í•©ê³„ ì²´í¬
            total = rsi_weight + macd_weight + ma_weight
            if abs(total - 1.0) > 0.01:
                st.warning(f"ê°€ì¤‘ì¹˜ í•©ê³„: {total:.2f} (1.0ì´ì–´ì•¼ í•¨)")

            st.markdown("---")
            st.write("**ì§€í‘œ ì‚¬ìš© ì„¤ì •**")

            col1, col2, col3 = st.columns(3)
            with col1:
                use_rsi = st.checkbox("RSI ì‚¬ìš©", value=True, help="RSI ì§€í‘œ ì‚¬ìš©")
            with col2:
                use_macd = st.checkbox("MACD ì‚¬ìš©", value=True, help="MACD ì§€í‘œ ì‚¬ìš©")
            with col3:
                use_ma = st.checkbox("MA ì‚¬ìš©", value=True, help="ì´ë™í‰ê·  ì‚¬ìš©")

            if not any([use_rsi, use_macd, use_ma]):
                st.warning("âš ï¸ ìµœì†Œ 1ê°œ ì§€í‘œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.")

            strategy_params = {
                "rsi_weight": rsi_weight,
                "macd_weight": macd_weight,
                "ma_weight": ma_weight,
                "use_rsi": use_rsi,
                "use_macd": use_macd,
                "use_ma": use_ma,
            }

        elif strategy_type == "hybrid":
            st.write("**1ë‹¨ê³„: ì „ëµ ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")

            col1, col2, col3 = st.columns(3)

            with col1:
                momentum_weight = st.slider(
                    "ëª¨ë©˜í…€",
                    0.0, 1.0, 0.40, 0.05,
                    help="ëª¨ë©˜í…€ ì „ëµ ê°€ì¤‘ì¹˜"
                )

            with col2:
                volume_weight = st.slider(
                    "ê±°ë˜ëŸ‰",
                    0.0, 1.0, 0.30, 0.05,
                    help="ê±°ë˜ëŸ‰ ì „ëµ ê°€ì¤‘ì¹˜"
                )

            with col3:
                technical_weight = st.slider(
                    "ê¸°ìˆ ì§€í‘œ",
                    0.0, 1.0, 0.30, 0.05,
                    help="ê¸°ìˆ ì§€í‘œ ì „ëµ ê°€ì¤‘ì¹˜"
                )

            # ê°€ì¤‘ì¹˜ í•©ê³„ ì²´í¬
            total_weight = momentum_weight + volume_weight + technical_weight
            if abs(total_weight - 1.0) > 0.01:
                st.warning(f"âš ï¸ ê°€ì¤‘ì¹˜ í•©ê³„: {total_weight:.2f} (1.0ì´ì–´ì•¼ í•¨)")
            else:
                st.success(f"âœ… ê°€ì¤‘ì¹˜ í•©ê³„: {total_weight:.2f}")

            # ìµœì†Œ ì ìˆ˜ ì„¤ì •
            min_score = st.slider(
                "ìµœì†Œ ì ìˆ˜",
                0.0, 1.0, 0.50, 0.05,
                help="ì´ ì ìˆ˜ ì´ìƒì¸ ì¢…ëª©ë§Œ ì„ ì •"
            )

            st.markdown("---")
            st.write("**2ë‹¨ê³„: ì„¸ë¶€ ì „ëµ ì„¤ì •**")

            # íƒ­ìœ¼ë¡œ ì„¸ë¶€ ì„¤ì • êµ¬ì„±
            tab_momentum, tab_volume, tab_technical = st.tabs([
                f"ğŸ“ˆ ëª¨ë©˜í…€ ì„¤ì • (ê°€ì¤‘ì¹˜: {momentum_weight:.0%})",
                f"ğŸ“Š ê±°ë˜ëŸ‰ ì„¤ì • (ê°€ì¤‘ì¹˜: {volume_weight:.0%})",
                f"ğŸ“‰ ê¸°ìˆ ì§€í‘œ ì„¤ì • (ê°€ì¤‘ì¹˜: {technical_weight:.0%})"
            ])

            with tab_momentum:
                st.write("**ëª¨ë©˜í…€ ì „ëµ íŒŒë¼ë¯¸í„°**")
                st.caption("ê°€ê²©/ê±°ë˜ëŸ‰/RSI ëª¨ë©˜í…€ì„ ì¡°í•©í•˜ì—¬ ì ìˆ˜ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.")

                st.write("**ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")
                momentum_price_weight = st.slider(
                    "ê°€ê²© ìƒìŠ¹ë¥  ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.4, 0.05,
                    key="hybrid_momentum_price_w",
                    help="ê°€ê²© ë³€ë™ë¥ ì˜ ê°€ì¤‘ì¹˜"
                )
                momentum_volume_weight = st.slider(
                    "ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨ ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.3, 0.05,
                    key="hybrid_momentum_volume_w",
                    help="ê±°ë˜ëŸ‰ ë³€ë™ë¥ ì˜ ê°€ì¤‘ì¹˜"
                )
                momentum_rsi_weight = st.slider(
                    "RSI ëª¨ë©˜í…€ ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.3, 0.05,
                    key="hybrid_momentum_rsi_w",
                    help="RSI ëª¨ë©˜í…€ì˜ ê°€ì¤‘ì¹˜"
                )

                momentum_total = momentum_price_weight + momentum_volume_weight + momentum_rsi_weight
                if abs(momentum_total - 1.0) > 0.01:
                    st.warning(f"âš ï¸ ëª¨ë©˜í…€ ê°€ì¤‘ì¹˜ í•©ê³„: {momentum_total:.2f} (1.0ì´ì–´ì•¼ í•¨)")
                else:
                    st.success(f"âœ… ëª¨ë©˜í…€ ê°€ì¤‘ì¹˜ í•©ê³„: {momentum_total:.2f}")

                st.markdown("---")
                st.write("**ê¸°ê°„ ì„¤ì •**")
                st.caption("ì„ íƒí•œ ê¸°ê°„ì˜ ëª¨ë©˜í…€ì„ ì¡°í•©í•˜ì—¬ í‰ê°€í•©ë‹ˆë‹¤.")

                col1, col2, col3 = st.columns(3)
                with col1:
                    momentum_period_1d = st.checkbox(
                        "1ì¼",
                        value=True,
                        key="hybrid_momentum_1d",
                        help="ìµœê·¼ 24ì‹œê°„"
                    )
                with col2:
                    momentum_period_7d = st.checkbox(
                        "7ì¼",
                        value=True,
                        key="hybrid_momentum_7d",
                        help="ìµœê·¼ 7ì¼"
                    )
                with col3:
                    momentum_period_30d = st.checkbox(
                        "30ì¼",
                        value=True,
                        key="hybrid_momentum_30d",
                        help="ìµœê·¼ 30ì¼"
                    )

                if not any([momentum_period_1d, momentum_period_7d, momentum_period_30d]):
                    st.warning("âš ï¸ ìµœì†Œ 1ê°œ ê¸°ê°„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.")

            with tab_volume:
                st.write("**ê±°ë˜ëŸ‰ ì „ëµ íŒŒë¼ë¯¸í„°**")
                st.caption("ê±°ë˜ëŒ€ê¸ˆê³¼ ê±°ë˜ëŸ‰ ê¸‰ì¦ì„ ì¡°í•©í•˜ì—¬ ì ìˆ˜ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.")

                st.write("**ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")
                volume_amount_weight = st.slider(
                    "ê±°ë˜ëŒ€ê¸ˆ ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.5, 0.05,
                    key="hybrid_volume_amount_w",
                    help="ê±°ë˜ëŒ€ê¸ˆ(ê±°ë˜ëŸ‰ * ê°€ê²©)ì˜ ê°€ì¤‘ì¹˜"
                )
                volume_surge_weight = st.slider(
                    "ê±°ë˜ëŸ‰ ê¸‰ì¦ ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.5, 0.05,
                    key="hybrid_volume_surge_w",
                    help="í‰ê·  ëŒ€ë¹„ ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨ì˜ ê°€ì¤‘ì¹˜"
                )

                volume_total = volume_amount_weight + volume_surge_weight
                if abs(volume_total - 1.0) > 0.01:
                    st.warning(f"âš ï¸ ê±°ë˜ëŸ‰ ê°€ì¤‘ì¹˜ í•©ê³„: {volume_total:.2f} (1.0ì´ì–´ì•¼ í•¨)")
                else:
                    st.success(f"âœ… ê±°ë˜ëŸ‰ ê°€ì¤‘ì¹˜ í•©ê³„: {volume_total:.2f}")

                st.markdown("---")
                st.write("**ì„ê³„ê°’ ì„¤ì •**")

                volume_threshold = st.slider(
                    "ê±°ë˜ëŸ‰ ë°°ìˆ˜",
                    min_value=1.0,
                    max_value=5.0,
                    value=1.5,
                    step=0.1,
                    key="hybrid_volume_threshold",
                    help="í‰ê·  ëŒ€ë¹„ Në°° ì´ìƒì´ë©´ ë†’ì€ ì ìˆ˜"
                )

                volume_period = st.number_input(
                    "í‰ê·  ê³„ì‚° ê¸°ê°„ (ì¼)",
                    min_value=5,
                    max_value=100,
                    value=20,
                    step=5,
                    key="hybrid_volume_period",
                    help="ìµœê·¼ Nì¼ í‰ê·  ê±°ë˜ëŸ‰ ê¸°ì¤€"
                )

            with tab_technical:
                st.write("**ê¸°ìˆ ì§€í‘œ ì „ëµ íŒŒë¼ë¯¸í„°**")
                st.caption("RSI, MACD, ì´ë™í‰ê·  ë“± ê¸°ìˆ ì§€í‘œë¥¼ ì¡°í•©í•˜ì—¬ ì ìˆ˜ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤.")

                st.write("**ê°€ì¤‘ì¹˜ ì„¤ì •** (í•©ê³„ 1.0)")
                technical_rsi_weight = st.slider(
                    "RSI ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.3, 0.05,
                    key="hybrid_technical_rsi_w",
                    help="RSI ì§€í‘œì˜ ê°€ì¤‘ì¹˜"
                )
                technical_macd_weight = st.slider(
                    "MACD ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.4, 0.05,
                    key="hybrid_technical_macd_w",
                    help="MACD ì§€í‘œì˜ ê°€ì¤‘ì¹˜"
                )
                technical_ma_weight = st.slider(
                    "ì´ë™í‰ê·  ê°€ì¤‘ì¹˜",
                    0.0, 1.0, 0.3, 0.05,
                    key="hybrid_technical_ma_w",
                    help="ì´ë™í‰ê· ì˜ ê°€ì¤‘ì¹˜"
                )

                technical_total = technical_rsi_weight + technical_macd_weight + technical_ma_weight
                if abs(technical_total - 1.0) > 0.01:
                    st.warning(f"âš ï¸ ê¸°ìˆ ì§€í‘œ ê°€ì¤‘ì¹˜ í•©ê³„: {technical_total:.2f} (1.0ì´ì–´ì•¼ í•¨)")
                else:
                    st.success(f"âœ… ê¸°ìˆ ì§€í‘œ ê°€ì¤‘ì¹˜ í•©ê³„: {technical_total:.2f}")

                st.markdown("---")
                st.write("**ì§€í‘œ ì‚¬ìš© ì„¤ì •**")

                col1, col2, col3 = st.columns(3)
                with col1:
                    technical_rsi = st.checkbox(
                        "RSI",
                        value=True,
                        key="hybrid_technical_rsi",
                        help="RSI ì§€í‘œ ì‚¬ìš©"
                    )
                with col2:
                    technical_macd = st.checkbox(
                        "MACD",
                        value=True,
                        key="hybrid_technical_macd",
                        help="MACD ì§€í‘œ ì‚¬ìš©"
                    )
                with col3:
                    technical_ma = st.checkbox(
                        "MA",
                        value=True,
                        key="hybrid_technical_ma",
                        help="ì´ë™í‰ê·  ì‚¬ìš©"
                    )

                if not any([technical_rsi, technical_macd, technical_ma]):
                    st.warning("âš ï¸ ìµœì†Œ 1ê°œ ê¸°ìˆ ì§€í‘œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.")

            strategy_params = {
                "strategy_weights": {
                    "momentum": momentum_weight,
                    "volume": volume_weight,
                    "technical": technical_weight
                },
                "min_score": min_score,
                # ëª¨ë©˜í…€ ì„¸ë¶€ ì„¤ì •
                "momentum_price_weight": momentum_price_weight,
                "momentum_volume_weight": momentum_volume_weight,
                "momentum_rsi_weight": momentum_rsi_weight,
                "momentum_period_1d": momentum_period_1d,
                "momentum_period_7d": momentum_period_7d,
                "momentum_period_30d": momentum_period_30d,
                # ê±°ë˜ëŸ‰ ì„¸ë¶€ ì„¤ì •
                "volume_amount_weight": volume_amount_weight,
                "volume_surge_weight": volume_surge_weight,
                "volume_threshold": volume_threshold,
                "volume_period": volume_period,
                # ê¸°ìˆ ì§€í‘œ ì„¸ë¶€ ì„¤ì •
                "technical_rsi_weight": technical_rsi_weight,
                "technical_macd_weight": technical_macd_weight,
                "technical_ma_weight": technical_ma_weight,
                "technical_rsi": technical_rsi,
                "technical_macd": technical_macd,
                "technical_ma": technical_ma,
            }

        st.markdown("<hr style='margin: 0.8rem 0;'>", unsafe_allow_html=True)

        # ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰ ë²„íŠ¼
        run_screening = st.button(
            "ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰",
            type="primary",
            use_container_width=True
        )

    # ë©”ì¸ ì˜ì—­
    if run_screening:
        with st.spinner("ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰ ì¤‘..."):
            try:
                # ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰
                results = screening_service.screen_symbols(
                    market=market,
                    strategy_type=strategy_type,
                    strategy_params=strategy_params,
                    top_n=top_n
                )

                # ê²°ê³¼ ì €ì¥
                st.session_state.screening_results = results
                st.session_state.screening_market = market
                st.session_state.screening_strategy = strategy_type
                st.session_state.screening_time = datetime.now()

            except Exception as e:
                logger.error(f"ìŠ¤í¬ë¦¬ë‹ ì‹¤íŒ¨: {e}")
                st.error(f"ìŠ¤í¬ë¦¬ë‹ ì‹¤íŒ¨: {e}")
                import traceback
                st.text(traceback.format_exc())

    # ê²°ê³¼ í‘œì‹œ
    if 'screening_results' in st.session_state and st.session_state.screening_results:
        results = st.session_state.screening_results

        st.markdown(f"<h3 style='margin-bottom: 10px;'>ìŠ¤í¬ë¦¬ë‹ ê²°ê³¼ (ìƒìœ„ {len(results)}ê°œ)</h3>", unsafe_allow_html=True)

        # ë©”íƒ€ ì •ë³´ - ì¹´ë“œí˜• ìŠ¤íƒ€ì¼
        st.markdown("""
        <style>
        .metric-card {
            background-color: #1E1E1E;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            border: 1px solid #3d3d4a;
        }
        .metric-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 4px;
        }
        .metric-value {
            font-size: 1rem;
            font-weight: 600;
            color: #FAFAFA;
        }
        </style>
        """, unsafe_allow_html=True)

        col1, col2, col3 = st.columns(3)
        with col1:
            st.markdown(f"""
            <div class="metric-card">
                <div class="metric-label">ì‹œì¥</div>
                <div class="metric-value">{st.session_state.screening_market}</div>
            </div>
            """, unsafe_allow_html=True)
        with col2:
            strategy_name = {
                "momentum": "ëª¨ë©˜í…€",
                "volume": "ê±°ë˜ëŸ‰",
                "technical": "ê¸°ìˆ ì§€í‘œ",
                "hybrid": "í•˜ì´ë¸Œë¦¬ë“œ"
            }.get(st.session_state.screening_strategy, "Unknown")
            st.markdown(f"""
            <div class="metric-card">
                <div class="metric-label">ì „ëµ</div>
                <div class="metric-value">{strategy_name}</div>
            </div>
            """, unsafe_allow_html=True)
        with col3:
            st.markdown(f"""
            <div class="metric-card">
                <div class="metric-label">ì‹¤í–‰ ì‹œê°„</div>
                <div class="metric-value">{st.session_state.screening_time.strftime("%H:%M:%S")}</div>
            </div>
            """, unsafe_allow_html=True)

        st.markdown("<div style='margin: 12px 0;'></div>", unsafe_allow_html=True)

        # ê²°ê³¼ í…Œì´ë¸”
        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ì„ ì • ì¢…ëª©</h3>", unsafe_allow_html=True)

        # DataFrame ìƒì„±
        data = []
        for i, result in enumerate(results, 1):
            row = {
                "ìˆœìœ„": i,
                "ì¢…ëª©": result.symbol,
                "ì ìˆ˜": result.score,
            }

            # ì„¸ë¶€ ì ìˆ˜ ì¶”ê°€
            for key, value in result.details.items():
                if isinstance(value, (int, float)):
                    row[key] = value
                else:
                    row[key] = str(value)

            data.append(row)

        df = pd.DataFrame(data)

        # ìˆ«ìí˜• ì»¬ëŸ¼ ì‹ë³„
        numeric_columns = df.select_dtypes(include=['float64', 'int64']).columns

        # ì»¬ëŸ¼ ìˆœì„œë¥¼ ì¬ë°°ì—´í•˜ê¸° ìœ„í•œ ìƒˆë¡œìš´ DataFrame êµ¬ì„±
        new_columns = ["ìˆœìœ„", "ì¢…ëª©"]

        for col in numeric_columns:
            if col not in ["ìˆœìœ„"]:  # ì „ì²´ ìˆœìœ„ ì»¬ëŸ¼ì€ ì œì™¸
                # ìˆœìœ„ ê³„ì‚° (ë‚´ë¦¼ì°¨ìˆœ - ë†’ì€ ê°’ì´ ì¢‹ìŒ)
                rank_col = f"{col}_R"
                df[rank_col] = df[col].rank(ascending=False, method='min').astype(int)

                # ê°’ ì»¬ëŸ¼ê³¼ ìˆœìœ„ ì»¬ëŸ¼ì„ ìˆœì„œëŒ€ë¡œ ì¶”ê°€
                new_columns.append(col)
                new_columns.append(rank_col)

        # ë¬¸ìì—´ ì»¬ëŸ¼ ì¶”ê°€ (ìˆœìœ„ê°€ ì—†ëŠ” ì»¬ëŸ¼ë“¤)
        for col in df.columns:
            if col not in new_columns and col not in numeric_columns:
                new_columns.append(col)

        # ì»¬ëŸ¼ ìˆœì„œ ì¬ë°°ì—´
        df = df[new_columns]

        # ì „ì²´ ì»¬ëŸ¼ ìˆ˜ ê³„ì‚°í•˜ì—¬ ë™ì  width ì„¤ì •
        total_cols = len(df.columns)

        # 1-5ìœ„ ìˆœìœ„ë¥¼ ê°•ì¡°í•˜ê¸° ìœ„í•´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        display_df = df.copy()
        for col in df.columns:
            if col.endswith("_R"):
                # 1-5ìœ„ëŠ” "1 â—", "2 â—" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                display_df[col] = df[col].apply(
                    lambda x: f"{int(x)} â—" if x <= 5 else str(int(x))
                )

        # ë™ì ìœ¼ë¡œ ì»¬ëŸ¼ ë„ˆë¹„ ê³„ì‚°
        # ì „ì²´ ì»¬ëŸ¼ ìˆ˜ì— ë”°ë¼ ê°’ ì»¬ëŸ¼ê³¼ R ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
        num_value_cols = len([c for c in df.columns if c not in ["ìˆœìœ„", "ì¢…ëª©"] and not c.endswith("_R")])

        # ê³ ì • ì»¬ëŸ¼: ìˆœìœ„(60px), ì¢…ëª©(120px)
        # R ì»¬ëŸ¼: 40px
        # ë‚˜ë¨¸ì§€ë¥¼ ê°’ ì»¬ëŸ¼ë“¤ì´ ê· ë“± ë¶„ë°°

        # ì»¬ëŸ¼ ì„¤ì •
        column_config = {}
        for col in display_df.columns:
            if col == "ìˆœìœ„":
                column_config[col] = st.column_config.NumberColumn(
                    col,
                    width=60
                )
            elif col == "ì¢…ëª©":
                column_config[col] = st.column_config.TextColumn(
                    col,
                    width=100
                )
            elif col.endswith("_R"):
                # ìˆœìœ„ ì»¬ëŸ¼ - "R"ë¡œ í‘œì‹œ
                column_config[col] = st.column_config.TextColumn(
                    "R",
                    width=45
                )
            elif col in numeric_columns and col != "ìˆœìœ„":
                column_config[col] = st.column_config.NumberColumn(
                    col,
                    width=90,
                    format="%.2f"
                )

        # ìŠ¤íƒ€ì¼ ì ìš© - í–‰ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½
        event = st.dataframe(
            display_df,
            use_container_width=True,
            hide_index=True,
            height=400,
            column_config=column_config,
            on_select="rerun",
            selection_mode="single-row"
        )

        # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        csv = df.to_csv(index=False, encoding='utf-8-sig')
        st.download_button(
            label="CSV ë‹¤ìš´ë¡œë“œ",
            data=csv,
            file_name=f"screening_{st.session_state.screening_market}_{st.session_state.screening_time.strftime('%Y%m%d_%H%M%S')}.csv",
            mime="text/csv"
        )

        st.markdown("<hr style='margin: 1rem 0;'>", unsafe_allow_html=True)

        # ìƒì„¸ ì •ë³´
        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ì¢…ëª© ìƒì„¸ ì •ë³´</h3>", unsafe_allow_html=True)

        # í…Œì´ë¸”ì—ì„œ ì„ íƒëœ í–‰ì´ ìˆëŠ”ì§€ í™•ì¸
        selected_symbol = None
        if event.selection and event.selection.rows:
            selected_row_idx = event.selection.rows[0]
            # display_dfì˜ í•´ë‹¹ í–‰ì—ì„œ ì¢…ëª©ëª… ê°€ì ¸ì˜¤ê¸°
            selected_symbol = display_df.iloc[selected_row_idx]["ì¢…ëª©"]
            st.info(f"ì„ íƒëœ ì¢…ëª©: **{selected_symbol}**")
        else:
            # í…Œì´ë¸”ì—ì„œ ì„ íƒì´ ì—†ìœ¼ë©´ selectboxë¡œ ì„ íƒ
            selected_symbol = st.selectbox(
                "ì¢…ëª© ì„ íƒ",
                options=[r.symbol for r in results],
                format_func=lambda x: f"{x} ({next(r.score for r in results if r.symbol == x):.2f}ì )"
            )

        if selected_symbol:
            selected_result = next(r for r in results if r.symbol == selected_symbol)

            col1, col2 = st.columns(2)

            with col1:
                st.write("**ê¸°ë³¸ ì •ë³´**")
                st.write(f"- ì¢…ëª©: {selected_result.symbol}")
                st.write(f"- ì´ì : {selected_result.score:.2f}")
                st.write(f"- í‰ê°€ ì‹œê°„: {selected_result.timestamp.strftime('%Y-%m-%d %H:%M:%S')}")

            with col2:
                st.write("**ì„¸ë¶€ ì ìˆ˜**")

                # ìˆ«ìí˜• ì„¸ë¶€ ì ìˆ˜ë§Œ ì¶”ì¶œ
                numeric_scores = {}
                for key, value in selected_result.details.items():
                    if isinstance(value, (int, float)):
                        numeric_scores[key] = value

                if numeric_scores:
                    # Radar chart ìƒì„±
                    import plotly.graph_objects as go

                    categories = list(numeric_scores.keys())
                    values = list(numeric_scores.values())

                    fig = go.Figure()

                    fig.add_trace(go.Scatterpolar(
                        r=values,
                        theta=categories,
                        fill='toself',
                        name=selected_result.symbol,
                        line=dict(color='#54A0FD'),
                        fillcolor='rgba(84, 160, 253, 0.3)'
                    ))

                    fig.update_layout(
                        polar=dict(
                            bgcolor='#262730',
                            radialaxis=dict(
                                visible=True,
                                range=[0, max(values) * 1.1] if values else [0, 100],
                                gridcolor='#3d3d4a',
                                linecolor='#3d3d4a'
                            ),
                            angularaxis=dict(
                                gridcolor='#3d3d4a',
                                linecolor='#3d3d4a',
                                color='#FAFAFA'
                            )
                        ),
                        showlegend=False,
                        height=400,
                        margin=dict(l=80, r=80, t=40, b=40),
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)',
                        font=dict(color='#FAFAFA')
                    )

                    st.plotly_chart(fig, use_container_width=True)

                # ë¹„ìˆ«ìí˜• í•­ëª©ì€ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                non_numeric = {k: v for k, v in selected_result.details.items()
                              if not isinstance(v, (int, float))}
                if non_numeric:
                    st.write("**ê¸°íƒ€ ì •ë³´**")
                    for key, value in non_numeric.items():
                        st.write(f"- {key}: {value}")

    else:
        # ì´ˆê¸° í™”ë©´
        st.info(
            "ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ì‹œì¥ê³¼ ì „ëµì„ ì„ íƒí•œ í›„ "
            "'ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”."
        )

        st.markdown("<hr style='margin: 1rem 0;'>", unsafe_allow_html=True)

        # ê°€ì´ë“œ
        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ìŠ¤í¬ë¦¬ë‹ ì „ëµ ì†Œê°œ</h3>", unsafe_allow_html=True)

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("""
            **ëª¨ë©˜í…€ ê¸°ë°˜**
            - ê°€ê²© ìƒìŠ¹ë¥ 
            - ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨
            - RSI ëª¨ë©˜í…€
            - ê°€ì¤‘ì¹˜ ì¡°í•©

            **ê±°ë˜ëŸ‰ ê¸°ë°˜**
            - ê±°ë˜ëŒ€ê¸ˆ ìˆœìœ„
            - ê±°ë˜ëŸ‰ ê¸‰ì¦ ê°ì§€
            - ìœ ë™ì„± ì ìˆ˜
            """)

        with col2:
            st.markdown("""
            **ê¸°ìˆ ì§€í‘œ ë³µí•©**
            - RSI
            - MACD
            - ì´ë™í‰ê·  ì •ë°°ì—´
            - ë³µí•© ì§€í‘œ ì ìˆ˜

            **í•˜ì´ë¸Œë¦¬ë“œ**
            - ì—¬ëŸ¬ ì „ëµ ì¡°í•©
            - ì „ëµë³„ ê°€ì¤‘ì¹˜
            - ìµœì  ì¡°í•© íƒìƒ‰
            """)

        st.markdown("<hr style='margin: 1rem 0;'>", unsafe_allow_html=True)

        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ì‚¬ìš© ë°©ë²•</h3>", unsafe_allow_html=True)

        st.markdown("""
        1. **ì‹œì¥ ì„ íƒ**: KRW ë˜ëŠ” BTC ì‹œì¥
        2. **ì „ëµ ì„ íƒ**: 4ê°€ì§€ ìŠ¤í¬ë¦¬ë‹ ì „ëµ ì¤‘ ì„ íƒ
        3. **íŒŒë¼ë¯¸í„° ì„¤ì •**: ì „ëµë³„ ê°€ì¤‘ì¹˜ ë° ì˜µì…˜ ì„¤ì •
        4. **ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰**: ìƒìœ„ Nê°œ ì¢…ëª© ìë™ ì„ ì •
        5. **ê²°ê³¼ ë¶„ì„**: ì„ ì •ëœ ì¢…ëª©ì˜ ì ìˆ˜ ë° ì„¸ë¶€ ì •ë³´ í™•ì¸
        """)

        st.markdown("<hr style='margin: 1rem 0;'>", unsafe_allow_html=True)

        st.markdown("<h3 style='margin-bottom: 0.8rem;'>ì£¼ì˜ì‚¬í•­</h3>", unsafe_allow_html=True)

        st.markdown("""
        <div style='background-color: #00CCAC70; border-left: 4px solid #00CCAC; padding: 16px; border-radius: 4px;'>
            <div style='font-size: 0.875rem; color: #FAFAFA; line-height: 1.6;'>
                â€¢ ìŠ¤í¬ë¦¬ë‹ ê²°ê³¼ëŠ” íˆ¬ì ì°¸ê³  ìë£Œì¼ ë¿, íˆ¬ì ê²°ì •ì˜ ê·¼ê±°ê°€ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>
                â€¢ ì‹œì¥ ìƒí™©ì— ë”°ë¼ ì ìˆ˜ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                â€¢ ì—¬ëŸ¬ ì „ëµì„ ì¡°í•©í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤<br>
                â€¢ ë°±í…ŒìŠ¤íŒ…ì„ í†µí•´ ì „ëµì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ì„¸ìš”
            </div>
        </div>
        """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
